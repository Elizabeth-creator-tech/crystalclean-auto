{% extends "base.html" %}

{% block title %}Admin Dashboard - CrystalClean Auto{% endblock %}

{% block content %}
<div class="dashboard-header" style="margin-bottom: 32px;">
    <h1 style="font-size: 32px; font-weight: 800; color: var(--text-dark);">Admin Dashboard</h1>
    <p style="color: var(--text-light); margin-top: 8px;">Welcome back, {{ current_user.username }}!</p>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Jobs Today</div>
        <div class="stat-value">{{ stats.total_jobs }}</div>
    </div>
    <div class="stat-card stat-warning">
        <div class="stat-label">In Progress</div>
        <div class="stat-value">{{ stats.in_progress }}</div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-label">Completed</div>
        <div class="stat-value">{{ stats.completed }}</div>
    </div>
    <div class="stat-card stat-info">
        <div class="stat-label">Revenue Today</div>
        <div class="stat-value">KSh {{ stats.revenue }}</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Quick Actions</h2>
    </div>
    <div class="card-body">
        <div class="flex gap-2" style="flex-wrap: wrap;">
            <a href="{{ url_for('add_car') }}" class="btn btn-primary">
                <span style="font-size: 18px; margin-right: 8px;">+</span> Add New Job
            </a>
            <a href="{{ url_for('manage_services') }}" class="btn btn-secondary">
                Manage Services
            </a>
            <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">
                Manage Users
            </a>
            <a href="{{ url_for('reports') }}" class="btn btn-secondary">
                Today's Reports
            </a>
            <a href="{{ url_for('analytics') }}" class="btn btn-secondary" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                Full Analytics
            </a>
        </div>
    </div>
</div>

<!-- Data Management -->
<div class="card" style="background: #0f172a;">
    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.3);">
        <h2 class="card-title" style="color: white;">Data Management</h2>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px; opacity: 0.95;">Manage your data: Archive completed jobs or clear today's data.</p>
        <div class="flex gap-2" style="flex-wrap: wrap;">
            <form method="POST" action="{{ url_for('archive_now') }}" style="display: inline;">
                <button type="submit" class="btn" style="background-color: white; color: #f5576c; font-weight: 600;">
                    Archive Old Jobs (24h+)
                </button>
            </form>
            <form method="POST" action="{{ url_for('clear_today_data') }}" style="display: inline;" onsubmit="return confirm('This will clear all of today\'s jobs! Completed jobs will be archived. Continue?')">
                <button type="submit" class="btn" style="background-color: rgba(255,255,255,0.2); color: white; border: 2px solid white;">
                    Clear Today's Data
                </button>
            </form>
            <a href="{{ url_for('view_archived_jobs') }}" class="btn" style="background-color: rgba(255,255,255,0.2); color: white; border: 2px solid white;">
                View Archived Jobs
            </a>
        </div>
        <p style="margin-top: 12px; font-size: 13px; opacity: 0.85;">
            <strong>Note:</strong> Completed jobs older than 24 hours are automatically archived.
        </p>
    </div>
</div>

<!-- Current Jobs Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Current Jobs</h2>
        <div class="search-bar" style="width: 300px;">
            <input type="text" class="form-control" placeholder="Search by plate number or customer..." id="searchInput" onkeyup="searchTable()">
        </div>
    </div>
    <div class="card-body">
        {% if cars %}
        <div class="table-responsive">
            <table class="table" id="jobsTable">
                <thead>
                    <tr>
                        <th>Plate Number</th>
                        <th>Customer Name</th>
                        <th>Phone</th>
                        <th>Service</th>
                        <th>Status</th>
                        <th>Assigned To</th>
                        <th>Time In</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for car in cars %}
                    <tr>
                        <td><strong>{{ car.plate_number }}</strong></td>
                        <td>{{ car.customer_name }}</td>
                        <td>{{ car.customer_phone }}</td>
                        <td>{{ car.service.name }}</td>
                        <td>
                            <span class="badge badge-{{ car.status.lower().replace(' ', '-') }}">
                                {{ car.status }}
                            </span>
                        </td>
                        <td>{{ car.assigned_user.username if car.assigned_user else 'Unassigned' }}</td>
                        <td>{{ car.time_in_display.strftime('%I:%M %p') if car.time_in_display else 'N/A' }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('edit_car', car_id=car.id) }}" class="btn btn-sm btn-secondary">Edit</a>
                                <form method="POST" action="{{ url_for('delete_car', car_id=car.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this job?')">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon"></div>
            <h3 class="empty-state-title">No Jobs Yet</h3>
            <p class="empty-state-text">Start by adding a new job to the system</p>
            <a href="{{ url_for('add_car') }}" class="btn btn-primary">Add First Job</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function searchTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('jobsTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;

        for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell) {
                const textValue = cell.textContent || cell.innerText;
                if (textValue.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }

        row.style.display = found ? '' : 'none';
    }
}
</script>
{% endblock %}