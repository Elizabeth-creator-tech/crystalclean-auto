{% extends "base.html" %}

{% block title %}Dashboard - CrystalClean Auto{% endblock %}

{% block content %}

<div class="card" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 1.5rem; margin-bottom: 0;">Dashboard Overview</h1>
            <p style="color: var(--text-secondary); margin: 0;">Welcome back, {{ current_user.username }}</p>
        </div>
        <div style="text-align: right;">
            <span class="badge badge-completed">Online</span>
        </div>
    </div>
</div>

<div class="stats-grid">
    <div class="card-stat primary">
        <div class="stat-icon">
            <i class="fas fa-car"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Cars Today</div>
            <div class="stat-value">{{ stats.total_jobs }}</div>
        </div>
    </div>

    <div class="card-stat warning">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">In Progress</div>
            <div class="stat-value">{{ stats.in_progress }}</div>
        </div>
    </div>

    <div class="card-stat success">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Completed</div>
            <div class="stat-value">{{ stats.completed }}</div>
        </div>
    </div>

    <div class="card-stat accent">
        <div class="stat-icon">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Today's Revenue</div>
            <div class="stat-value">KSh {{ stats.revenue }}</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Quick Actions</h2>
    </div>
    <div class="actions-grid">
        <a href="{{ url_for('add_car') }}" class="action-btn">
            <i class="fas fa-plus"></i>
            <span>New Job</span>
        </a>

        <a href="{{ url_for('manage_services') }}" class="action-btn">
            <i class="fas fa-cog"></i>
            <span>Services</span>
        </a>

        <a href="{{ url_for('manage_users') }}" class="action-btn">
            <i class="fas fa-users"></i>
            <span>Staff</span>
        </a>

        <a href="{{ url_for('reports') }}" class="action-btn">
            <i class="fas fa-file-alt"></i>
            <span>Reports</span>
        </a>

        <a href="{{ url_for('analytics') }}" class="action-btn">
            <i class="fas fa-chart-line"></i>
            <span>Analytics</span>
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Active Jobs</h2>
        <div class="search-bar" style="max-width: 300px; width: 100%;">
            <input type="text" class="form-control" placeholder="Search plate or customer..." id="searchInput"
                onkeyup="searchTable()">
        </div>
    </div>

    {% if cars %}
    <div class="table-responsive">
        <table class="table" id="jobsTable">
            <thead>
                <tr>
                    <th>Plate</th>
                    <th>Customer</th>
                    <th>Phone</th>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Staff</th>
                    <th>Time In</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for car in cars %}
                <tr>
                    <td data-label="Plate"><strong>{{ car.plate_number }}</strong></td>
                    <td data-label="Customer">{{ car.customer_name }}</td>
                    <td data-label="Phone">{{ car.customer_phone }}</td>
                    <td data-label="Service">{{ car.service.name }}</td>
                    <td data-label="Status">
                        <span class="badge badge-{{ car.status.lower().replace(' ', '-') }}">
                            {{ car.status }}
                        </span>
                    </td>
                    <td data-label="Staff">{{ car.assigned_user.username if car.assigned_user else 'Unassigned' }}</td>
                    <td data-label="Time In">{{ car.time_in_display.strftime('%I:%M %p') if car.time_in_display else
                        'N/A' }}</td>
                    <td data-label="Actions">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <a href="{{ url_for('edit_car', car_id=car.id) }}" class="btn btn-sm btn-secondary">Edit</a>
                            <form method="POST" action="{{ url_for('delete_car', car_id=car.id) }}"
                                style="display: inline;" onsubmit="return confirm('Delete this job?')">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">ðŸš—</div>
        <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem;">No Active Jobs</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Start by adding your first car wash job</p>
        <a href="{{ url_for('add_car') }}" class="btn btn-primary">Add First Job</a>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Data Management</h2>
    </div>
    <div>
        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Archive completed jobs or clear today's records
        </p>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <form method="POST" action="{{ url_for('archive_now') }}" style="display: inline;">
                <button type="submit" class="btn btn-secondary">Archive Old Jobs</button>
            </form>
            <form method="POST" action="{{ url_for('clear_today_data') }}" style="display: inline;"
                onsubmit="return confirm('Clear all today\'s data?')">
                <button type="submit" class="btn btn-danger">Clear Today</button>
            </form>
            <a href="{{ url_for('view_archived_jobs') }}" class="btn btn-secondary">View Archive</a>
        </div>
        <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
            Jobs older than 24 hours are automatically archived
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function searchTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('jobsTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            let found = false;

            for (let j = 0; j < cells.length; j++) {
                const cell = cells[j];
                if (cell) {
                    const textValue = cell.textContent || cell.innerText;
                    if (textValue.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
            }

            row.style.display = found ? '' : 'none';
        }
    }
</script>
{% endblock %}